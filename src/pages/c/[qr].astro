---
import Layout from "../../layouts/Layout.astro";

const { qr } = Astro.params;

type Connector = {
  id: number;
  station_id: number;
  evse_id: number;
  charge_point_id: string;
  standard: string;
  format: string;
  qr_code: string;
  status: string;
  power_type: string;
  max_voltage: number;
  max_amperage: number;
  max_electric_power: number;
  tariff_ids: number[];
  terms_and_conditions: string | null;
  last_updated: string;
};

let connector: Connector | null = null;
let errorMsg = "";

try {
  const res = await fetch(`${Astro.url.origin}/api/connectors`, {
    headers: { Accept: "application/json" },
  });
  if (!res.ok) {
    errorMsg = `API error: ${res.status} ${res.statusText}`;
  } else {
    const list = (await res.json()) as Connector[];
    connector = list.find((c) => String(c.qr_code).trim() === String(qr).trim()) ?? null;
  }
} catch (e: any) {
  errorMsg = e?.message ?? "Failed to load connector";
}
---

<Layout title={`Connector ${qr}`}>
  <h1 style="font-size:22px; margin:0 0 10px;">Connector detail</h1>
  <div style="opacity:.85; margin-bottom:12px;">QR: <b>{qr}</b></div>

  {errorMsg ? (
    <div style="padding:14px; border-radius:12px; background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.35);">
      {errorMsg}
    </div>
  ) : !connector ? (
    <div style="padding:14px; border-radius:12px; background:rgba(251,191,36,.10); border:1px solid rgba(251,191,36,.25);">
      Connector not found for this QR.
    </div>
  ) : (
    <>
      <div style="border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.65); border-radius:16px; padding:14px;">
        <pre style="white-space:pre-wrap; margin:0; font-size:13px; opacity:.92;">
{JSON.stringify(connector, null, 2)}
        </pre>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="btnStart" style="padding:10px 12px; border-radius:10px; border:1px solid rgba(34,197,94,.35); background:rgba(34,197,94,.12); color:inherit; cursor:pointer;">
          Start Charge
        </button>

        <button id="btnStop" disabled style="padding:10px 12px; border-radius:10px; border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:inherit; cursor:pointer; opacity:.5;">
          Stop Charge
        </button>

        <div style="opacity:.85; font-size:14px;">
          Session: <b id="sessionId">-</b>
        </div>
      </div>

      <div id="msg" style="margin-top:10px; font-size:13px; opacity:.85;"></div>

      <script define:vars={{ connector }}>
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");
        const sessionEl = document.getElementById("sessionId");
        const msgEl = document.getElementById("msg");

        function setMsg(t) { msgEl.textContent = t || ""; }

        function setSession(id) {
          sessionEl.textContent = id || "-";
          const has = !!id;
          btnStop.disabled = !has;
          btnStop.style.opacity = has ? "1" : ".5";
          btnStart.disabled = has; // эхэлсэн үед дахиж start хийхгүй
          btnStart.style.opacity = has ? ".5" : "1";
        }

        // Optional: localStorage-д хадгалах
        const key = `senergy_session_${connector.qr_code}`;
        const saved = localStorage.getItem(key);
        if (saved) setSession(saved);

        btnStart.addEventListener("click", async () => {
          setMsg("Starting...");
          try {
            const res = await fetch("/api/start-session", {
              method: "POST",
              headers: { "Content-Type": "application/json", Accept: "application/json" },
              body: JSON.stringify({
                station_id: connector.station_id,
                evse_id: connector.evse_id,
                connector_id: connector.id,
              }),
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.error || `Start failed: ${res.status}`);

            // ✅ API чинь session_id-г өөр нэрээр өгч магадгүй.
            const sid = data?.session_id ?? data?.id ?? data?.session?.id;
            if (!sid) throw new Error("Started but session_id not returned. Check API response.");

            localStorage.setItem(key, String(sid));
            setSession(String(sid));
            setMsg("Started.");
          } catch (e) {
            setMsg(e?.message || "Start failed");
          }
        });

        btnStop.addEventListener("click", async () => {
          const sid = localStorage.getItem(key);
          if (!sid) return;

          setMsg("Stopping...");
          try {
            const res = await fetch(`/api/stop-session/${encodeURIComponent(sid)}`, {
              method: "POST",
              headers: { Accept: "application/json" },
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.error || `Stop failed: ${res.status}`);

            localStorage.removeItem(key);
            setSession("");
            setMsg("Stopped.");
          } catch (e) {
            setMsg(e?.message || "Stop failed");
          }
        });
      </script>
    </>
  )}
</Layout>
