---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";

const { qr } = Astro.params;

type Connector = {
  id: number;
  station_id: number;
  evse_id: number;
  charge_point_id: string;
  standard: string;
  format: string;
  qr_code: string;
  status: string;
  power_type: string;
  max_voltage: number;
  max_amperage: number;
  max_electric_power: number;
  tariff_ids: number[];
  terms_and_conditions: string | null;
  last_updated: string;
};

type Tariff = {
  id: number;
  currency?: string; // "MNT"
  elements?: Array<{
    price_components?: Array<{
      type?: string;     // "ENERGY"
      price?: string;    // "1300.0000"
      vat?: string;
      step_size?: number;
    }>;
    restrictions?: any;
  }>;
};

type TariffsResponse = Tariff[]; // ‚úÖ ARRAY

let connector: Connector | null = null;
let errorMsg = "";

// ‚úÖ tariff price
let energyPrice: number | null = null;
let energyCurrency: string | null = null;

try {
  const res = await fetch(`${Astro.url.origin}/api/connectors`, {
    headers: { Accept: "application/json" },
  });

  if (!res.ok) {
    errorMsg = `API error: ${res.status}`;
  } else {
    const list = (await res.json()) as Connector[];
    connector = list.find((c) => String(c.qr_code).trim() === String(qr).trim()) ?? null;

    // ‚úÖ connector –æ–ª–¥—Å–æ–Ω –±–æ–ª —Ç–∞—Ä–∏—Ñ —Ç–∞—Ç–Ω–∞
    if (connector) {
      const tRes = await fetch(
        `${Astro.url.origin}/api/connector/${connector.id}/tariffs`,
        { headers: { Accept: "application/json" } }
      );

      if (tRes.ok) {
        const tData = (await tRes.json()) as TariffsResponse;

        let foundPrice: number | null = null;
        let foundCurrency: string | null = null;

        for (const tariff of Array.isArray(tData) ? tData : []) {
          const currency = tariff.currency ?? null;

          for (const el of tariff.elements ?? []) {
            for (const pc of el.price_components ?? []) {
              if (String(pc.type).toUpperCase() === "ENERGY") {
                const p = pc.price != null ? Number(pc.price) : NaN;
                if (Number.isFinite(p)) {
                  foundPrice = p;
                  foundCurrency = currency;
                  break;
                }
              }
            }
            if (foundPrice !== null) break;
          }
          if (foundPrice !== null) break;
        }

        energyPrice = foundPrice;
        energyCurrency = foundCurrency;
      }
    }
  }
} catch (e: any) {
  errorMsg = e?.message ?? "Failed to load connector";
}

function fmtPower(w: number) {
  const n = Number(w);
  if (!Number.isFinite(n)) return "-";
  if (n >= 1000) return `${(n / 1000).toFixed(1)} kW`;
  return `${n} W`;
}

function fmtCurrencySymbol(cur: string | null) {
  if (!cur) return "MNT";
  const c = cur.toUpperCase();
  if (c === "MNT") return "‚ÇÆ";
  return c;
}
---

<Layout title={`Connector ${qr}`}>
  <div class="mx-auto max-w-xl">

    <!-- HEADER -->
    <div class="mb-6 flex items-center gap-4">
      <div class="flex h-14 w-14 items-center justify-center rounded-2xl bg-green-600 text-white text-2xl shadow">
        ‚ö°
      </div>
      <div>
        <h1 class="text-xl font-bold leading-tight">Charging Connector</h1>
        <p class="text-sm text-slate-500">QR: {qr}</p>
      </div>
    </div>

    {errorMsg ? (
      <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-red-700">
        {errorMsg}
      </div>
    ) : !connector ? (
      <div class="rounded-xl border border-yellow-200 bg-yellow-50 p-4 text-yellow-700">
        Connector –æ–ª–¥—Å–æ–Ω–≥“Ø–π
      </div>
    ) : (
      <>
        <!-- CONNECTOR CARD -->
        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">

          <!-- STATUS -->
          <div class="mb-3 flex items-center justify-between">
            <div class="text-sm font-semibold text-slate-600">
              Station #{connector.station_id}
            </div>

            <span class={`rounded-full px-3 py-1 text-xs font-semibold
              ${connector.status === "Available" 
                ? "bg-green-100 text-green-700" 
                : "bg-orange-100 text-orange-700"}`}>
              {connector.status}
            </span>
          </div>

          <!-- POWER BIG -->
          <div class="mb-4">
            <div class="text-4xl font-extrabold tracking-tight text-slate-900">
              {fmtPower(connector.max_electric_power)}
            </div>
            <div class="text-sm text-slate-500">
              {connector.power_type} ‚Ä¢ {connector.standard}
            </div>
          </div>

          <!-- INFO GRID -->
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">Voltage</div>
              <div class="font-semibold">{connector.max_voltage} V</div>
            </div>

            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">Current</div>
              <div class="font-semibold">{connector.max_amperage} A</div>
            </div>

            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">EVSE ID</div>
              <div class="font-semibold">{connector.evse_id}</div>
            </div>

            <!-- üí∞ PRICE box (Charge Point –æ—Ä–æ–Ω–¥) -->
            <div class="rounded-xl bg-green-50 p-3 border border-green-200">
              <div class="text-green-700">Price</div>
              <div class="font-bold text-green-900 text-lg">
                {energyPrice !== null
                  ? `${energyPrice.toLocaleString()} ${fmtCurrencySymbol(energyCurrency)} / kWh`
                  : "‚Äî"}
              </div>
              <div class="text-xs text-green-700/70">
                {energyPrice !== null ? "ENERGY tariff" : "Tariff not available"}
              </div>
            </div>
          </div>

          <!-- Optional: tariff id chips -->
          <div class="mt-4">
            <div class="mb-2 text-sm font-semibold text-slate-600">Tariff IDs</div>
            {connector.tariff_ids?.length ? (
              <div class="flex flex-wrap gap-2">
                {connector.tariff_ids.map((tid) => (
                  <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
                    #{tid}
                  </span>
                ))}
              </div>
            ) : (
              <div class="text-sm text-slate-400">No tariff IDs</div>
            )}
          </div>
        </div>

        <!-- ACTION BAR -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <button
            id="btnStart"
            class="w-full rounded-2xl bg-green-800 py-4 text-lg font-bold text-white shadow-md transition active:scale-[0.98] hover:bg-green-500"
          >
            ‚ö° Start Charging
          </button>

          <div id="msg" class="mt-3 text-center text-sm text-slate-600"></div>
        </div>

        <!-- SCRIPT -->
        <script define:vars={{ connector }}>
          const msgEl = document.getElementById("msg");
          const btnStart = document.getElementById("btnStart");

          function setMsg(t) { msgEl.textContent = t || ""; }

          btnStart.addEventListener("click", async () => {
            setMsg("Starting charging session...");
            btnStart.disabled = true;
            btnStart.classList.add("opacity-60");

            try {
              const res = await fetch("/api/start-session", {
                method: "POST",
                headers: { "Content-Type": "application/json", Accept: "application/json" },
                body: JSON.stringify({
                  station_id: connector.station_id,
                  evse_id: connector.evse_id,
                  connector_id: connector.id,
                }),
              });

              const data = await res.json().catch(() => ({}));
              if (!res.ok) throw new Error(data?.error || `Start failed: ${res.status}`);

              const sid = data?.session_id ?? data?.id ?? data?.session?.id ?? data?.data?.session_id;
              if (!sid) throw new Error("Session ID not returned from server");

              window.location.href = `/session/${encodeURIComponent(String(sid))}`;
            } catch (e) {
              setMsg(e?.message || "Start failed");
              btnStart.disabled = false;
              btnStart.classList.remove("opacity-60");
            }
          });
        </script>
      </>
    )}
  </div>
</Layout>
