---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";

const { qr } = Astro.params;

type Connector = {
  id: number;
  station_id: number;
  evse_id: number;
  charge_point_id: string;
  standard: string;
  format: string;
  qr_code: string;
  status: string;
  power_type: string;
  max_voltage: number;
  max_amperage: number;
  max_electric_power: number;
  tariff_ids: number[];
  terms_and_conditions: string | null;
  last_updated: string;
};

let connector: Connector | null = null;
let errorMsg = "";

try {
  const res = await fetch(`${Astro.url.origin}/api/connectors`, { headers: { Accept: "application/json" } });
  if (!res.ok) errorMsg = `API error: ${res.status}`;
  else {
    const list = (await res.json()) as Connector[];
    connector = list.find((c) => String(c.qr_code).trim() === String(qr).trim()) ?? null;
  }
} catch (e: any) {
  errorMsg = e?.message ?? "Failed to load connector";
}

function fmtPower(w: number) {
  const n = Number(w);
  if (!Number.isFinite(n)) return "-";
  if (n >= 1000) return `${(n / 1000).toFixed(1)} kW`;
  return `${n} W`;
}
---

<Layout title={`Connector ${qr}`}>
  <div class="mx-auto max-w-xl">

    <!-- HEADER -->
    <div class="mb-6 flex items-center gap-4">
      <div class="flex h-14 w-14 items-center justify-center rounded-2xl bg-green-600 text-white text-2xl shadow">
        ⚡
      </div>
      <div>
        <h1 class="text-xl font-bold leading-tight">Charging Connector</h1>
        <p class="text-sm text-slate-500">QR: {qr}</p>
      </div>
    </div>

    {errorMsg ? (
      <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-red-700">
        {errorMsg}
      </div>
    ) : !connector ? (
      <div class="rounded-xl border border-yellow-200 bg-yellow-50 p-4 text-yellow-700">
        Connector олдсонгүй
      </div>
    ) : (
      <>
        <!-- CONNECTOR CARD -->
        <div class="rounded-3xl border border-slate-200 bg-white p-5 shadow-sm">

          <!-- STATUS -->
          <div class="mb-3 flex items-center justify-between">
            <div class="text-sm font-semibold text-slate-600">
              Station #{connector.station_id}
            </div>

            <span class={`rounded-full px-3 py-1 text-xs font-semibold
              ${connector.status === "Available" 
                ? "bg-green-100 text-green-700" 
                : "bg-orange-100 text-orange-700"}`}>
              {connector.status}
            </span>
          </div>

          <!-- POWER BIG -->
          <div class="mb-4">
            <div class="text-4xl font-extrabold tracking-tight text-slate-900">
              {fmtPower(connector.max_electric_power)}
            </div>
            <div class="text-sm text-slate-500">
              {connector.power_type} • {connector.standard}
            </div>
          </div>

          <!-- INFO GRID -->
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">Voltage</div>
              <div class="font-semibold">{connector.max_voltage} V</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">Current</div>
              <div class="font-semibold">{connector.max_amperage} A</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">EVSE ID</div>
              <div class="font-semibold">{connector.evse_id}</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-3">
              <div class="text-slate-500">Charge Point</div>
              <div class="font-semibold">{connector.charge_point_id}</div>
            </div>
          </div>

        </div>

        <!-- ACTION BAR -->
        <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <button
            id="btnStart"
            class="w-full rounded-2xl bg-green-600 py-4 text-lg font-bold text-white shadow-md transition active:scale-[0.98] hover:bg-green-500"
          >
            ⚡ Start Charging
          </button>

          <div id="msg" class="mt-3 text-center text-sm text-slate-600"></div>
        </div>

        <!-- SCRIPT -->
        <script define:vars={{ connector }}>
          const msgEl = document.getElementById("msg");
          const btnStart = document.getElementById("btnStart");

          function setMsg(t) { msgEl.textContent = t || ""; }

          btnStart.addEventListener("click", async () => {
            setMsg("Starting charging session...");
            btnStart.disabled = true;
            btnStart.classList.add("opacity-60");

            try {
              const res = await fetch("/api/start-session", {
                method: "POST",
                headers: { "Content-Type": "application/json", Accept: "application/json" },
                body: JSON.stringify({
                  station_id: connector.station_id,
                  evse_id: connector.evse_id,
                  connector_id: connector.id,
                }),
              });

              const data = await res.json().catch(() => ({}));
              if (!res.ok) throw new Error(data?.error || `Start failed: ${res.status}`);

              const sid = data?.session_id ?? data?.id ?? data?.session?.id ?? data?.data?.session_id;
              if (!sid) throw new Error("Session ID not returned from server");

              window.location.href = `/session/${encodeURIComponent(String(sid))}`;
            } catch (e) {
              setMsg(e?.message || "Start failed");
              btnStart.disabled = false;
              btnStart.classList.remove("opacity-60");
            }
          });
        </script>
      </>
    )}
  </div>
</Layout>
