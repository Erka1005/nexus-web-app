---
import Layout from "../../layouts/Layout.astro";

const { qr } = Astro.params;

type Connector = {
  id: number;
  station_id: number;
  evse_id: number;
  charge_point_id: string;
  standard: string;
  format: string;
  qr_code: string;
  status: string;
  power_type: string;
  max_voltage: number;
  max_amperage: number;
  max_electric_power: number;
  tariff_ids: number[];
  terms_and_conditions: string | null;
  last_updated: string;
};

let connector: Connector | null = null;
let errorMsg = "";

try {
  // Proxy-оор татна (CORS-safe)
  const res = await fetch(`${Astro.url.origin}/api/connectors`, { headers: { Accept: "application/json" } });
  if (!res.ok) {
    errorMsg = `API error: ${res.status} ${res.statusText}`;
  } else {
    const list = (await res.json()) as Connector[];
    connector = list.find((c) => String(c.qr_code).trim() === String(qr).trim()) ?? null;
  }
} catch (e: any) {
  errorMsg = e?.message ?? "Failed to load connector";
}

function fmtPower(w: number) {
  const n = Number(w);
  if (!Number.isFinite(n)) return "-";
  if (n >= 1000) return `${(n / 1000).toFixed(1)} kW`;
  return `${n} W`;
}
---

<Layout title={`Connector ${qr}`}>
  <h1 style="font-size:22px; margin:0 0 8px;">Connector</h1>
  <div style="opacity:.85; margin-bottom:12px;">QR: <b>{qr}</b></div>

  {errorMsg ? (
    <div style="padding:14px; border-radius:14px; background:rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.35);">
      {errorMsg}
    </div>
  ) : !connector ? (
    <div style="padding:14px; border-radius:14px; background:rgba(251,191,36,.10); border:1px solid rgba(251,191,36,.25);">
      Connector олдсонгүй.
    </div>
  ) : (
    <>
      <div style="padding:14px; border-radius:16px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.65);">
        <div style="display:grid; gap:6px; font-size:14px; opacity:.95;">
          <div><b>ID:</b> {connector.id}</div>
          <div><b>Station:</b> {connector.station_id}</div>
          <div><b>EVSE:</b> {connector.evse_id}</div>
          <div><b>ChargePoint:</b> {connector.charge_point_id}</div>
          <div><b>Status:</b> {connector.status}</div>
          <div><b>Power:</b> {connector.power_type} • {fmtPower(connector.max_electric_power)} • {connector.max_voltage}V • {connector.max_amperage}A</div>
          <div><b>Tariff IDs:</b> {connector.tariff_ids?.length ? connector.tariff_ids.join(", ") : "-"}</div>
          <div><b>Updated:</b> {connector.last_updated}</div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="btnStart"
          style="padding:10px 12px; border-radius:12px; border:1px solid rgba(34,197,94,.35); background:rgba(34,197,94,.12); color:inherit; cursor:pointer;">
          Start Charging
        </button>

        <div id="msg" style="opacity:.85; font-size:13px;"></div>
      </div>

      <script define:vars={{ connector }}>
        const msgEl = document.getElementById("msg");
        const btnStart = document.getElementById("btnStart");

        function setMsg(t) { msgEl.textContent = t || ""; }

        btnStart.addEventListener("click", async () => {
          setMsg("Starting...");
          btnStart.disabled = true;
          btnStart.style.opacity = ".6";

          try {
            const res = await fetch("/api/start-session", {
              method: "POST",
              headers: { "Content-Type": "application/json", Accept: "application/json" },
              body: JSON.stringify({
                station_id: connector.station_id,
                evse_id: connector.evse_id,
                connector_id: connector.id,
              }),
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.error || `Start failed: ${res.status}`);

            // start-session response дээр session_id ямар нэртэй ирэхийг 100% мэдэхгүй тул хэдэн боломж шалгалаа
            const sid = data?.session_id ?? data?.id ?? data?.session?.id ?? data?.data?.session_id;
            if (!sid) throw new Error("Start амжилттай боловч session_id ирсэнгүй. (start-session response-оо paste хийгээрэй)");

            // Session page руу оруулна
            window.location.href = `/session/${encodeURIComponent(String(sid))}`;
          } catch (e) {
            setMsg(e?.message || "Start failed");
            btnStart.disabled = false;
            btnStart.style.opacity = "1";
          }
        });
      </script>
    </>
  )}
</Layout>
