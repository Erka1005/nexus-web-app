---
import Layout from "../../layouts/Layout.astro";

const { session_id } = Astro.params;
---

<Layout title={`Session ${session_id}`}>
  <h1 style="font-size:22px; margin:0 0 8px;">Charging Session</h1>
  <div style="opacity:.85; margin-bottom:12px;">Session ID: <b>{session_id}</b></div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
    <button id="btnStop"
      style="padding:10px 12px; border-radius:12px; border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12); color:inherit; cursor:pointer;">
      Stop Charging
    </button>

    <button id="btnRefresh"
      style="padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:rgba(15,23,42,.6); color:inherit; cursor:pointer;">
      Refresh
    </button>

    <div id="msg" style="opacity:.85; font-size:13px; align-self:center;"></div>
  </div>

  <div style="padding:14px; border-radius:16px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.65);">
    <div style="font-weight:700; margin-bottom:8px;">Session data</div>
    <pre id="json" style="margin:0; white-space:pre-wrap; font-size:13px; opacity:.92;">Loading...</pre>
  </div>

  <script define:vars={{ session_id }}>
    const msgEl = document.getElementById("msg");
    const jsonEl = document.getElementById("json");
    const btnStop = document.getElementById("btnStop");
    const btnRefresh = document.getElementById("btnRefresh");

    function setMsg(t) { msgEl.textContent = t || ""; }

    async function loadSession() {
      try {
        setMsg("Loading session...");
        const res = await fetch(`/api/session/${encodeURIComponent(String(session_id))}`, {
          headers: { Accept: "application/json" },
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || `Session API error: ${res.status}`);

        jsonEl.textContent = JSON.stringify(data, null, 2);
        setMsg("");
      } catch (e) {
        setMsg(e?.message || "Failed to load session");
      }
    }

    // poll every 7 seconds
    let timer = null;
    function startPolling() {
      if (timer) clearInterval(timer);
      timer = setInterval(loadSession, 7000);
    }

    btnRefresh.addEventListener("click", () => loadSession());

    btnStop.addEventListener("click", async () => {
      btnStop.disabled = true;
      btnStop.style.opacity = ".6";
      setMsg("Stopping...");

      try {
        const res = await fetch(`/api/stop-session/${encodeURIComponent(String(session_id))}`, {
          method: "POST",
          headers: { Accept: "application/json" },
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || `Stop failed: ${res.status}`);

        setMsg("Stopped. Refreshing...");
        await loadSession();

        // Дараагийн алхам: Pay page руу оруулах бол энд redirect хийнэ:
        // window.location.href = `/session/${encodeURIComponent(String(session_id))}/pay`;
      } catch (e) {
        setMsg(e?.message || "Stop failed");
      } finally {
        btnStop.disabled = false;
        btnStop.style.opacity = "1";
      }
    });

    // initial
    loadSession();
    startPolling();

    window.addEventListener("beforeunload", () => {
      if (timer) clearInterval(timer);
    });
  </script>
</Layout>
